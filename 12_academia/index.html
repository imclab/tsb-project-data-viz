<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TSB Data Viz</title>
<style type="text/css">
html, body {
  height: 100%;
  overflow: hidden;
}
text {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 12px;
}
.tooltip {
  display: none;
}
</style>
<script type="text/javascript" src="../lib/d3.v3.min.js"></script>
<script type="text/javascript" src="../js/fields.js"></script>
<script type="text/javascript" src="sparql.js"></script>
<script type="text/javascript" src="d3-grid.js"></script>
<script type="text/javascript" src="q.min.js"></script>
<script type="text/javascript" src="lodash.js"></script>
<script type="text/javascript" src="DataSet.js"></script>
<script type="text/javascript" src="SPARQLDataSource.js"></script>
<script type="text/javascript">

var odiColors = [
  '#2254F4', '#00B7FF', '#08DEF9', '#1DD3A7',
  '#0DBC37', '#67EF67', '#F9BC26', '#FF6700',
  '#D60303', '#EF3AAB', '#E6007C', '#B13198'
];

var regionsMap = {
  'E12000001' : 'North East',
  'E12000002' : 'North West',
  'E12000003' : 'Yorkshire and The Humber',
  'E12000004' : 'East Midlands',
  'E12000005' : 'West Midlands',
  'E12000006' : 'East of England',
  'E12000007' : 'London',
  'E12000008' : 'South East',
  'E12000009' : 'South West',
  'S92000003' : 'Scotland',
  'N92000002' : 'Northern Ireland',
  'W92000004' : 'Wales'
};

var w = window.innerWidth;
var h = window.innerHeight;

var ds = new SPARQLDataSource();

function seq(n) {
  var result = [];
  for(var i=0; i<n; i++) {
    result.push(i);
  }
  return result;
}

function inital(list, n) {
  return list.slice(0, n);
}

function superPoints(r, p) {
  var npoints = 64;
  return seq(npoints).map(function(i) {
    var angle = Math.PI*2*i/(npoints-1);
    var xsign = 1;
    var ysign = 1;
    if (angle > 3 * Math.PI/2) {
      angle = 2 * Math.PI - angle;
      xsign = 1;
      ysign = -1;
    }
    else if (angle > 2 * Math.PI/2) {
      angle = angle - Math.PI;
      xsign = -1;
      ysign = -1;
    }
    else if (angle > Math.PI/2) {
      angle = Math.PI - angle;
      xsign = -1;
      ysign = 1;
    }
    return {
      x: xsign * r * Math.pow(Math.cos(angle), 2/p),
      y: ysign * r * Math.pow(Math.sin(angle), 2/p)
    }
  })
}

function init() {
  svg = d3.select('#charts').append('svg')
    .attr('width', w)
    .attr('height', h);

  loadAcademicInstitutions();
}

function loadAcademicInstitutions() {
  var margin = 50;
  var rectGrid = d3.layout.grid()
    .bands()
    .size([w-2*margin, h-2*margin])
    .padding([0, 0]);

  var lineFunction = d3.svg.line()
                           .x(function(d) { return d.x; })
                           .y(function(d) { return d.y; })
                           .interpolate("linear");

  ds.getAcademicInstitutions().then(function(data) {
    data.rows.forEach(function(row) {
      row.numProjects = Number(row.numProjects);
      row.id = row.org.substr(row.org.lastIndexOf('/')+1)
    });

    data.rows.sort(function(a, b) {
      return b.numProjects - a.numProjects;
    })

    var topBest = inital(data.rows, 12);

    console.log(topBest[0])

    var maxNumProjects = _.max(topBest, 'numProjects').numProjects;

    var sizeScale = d3.scale.linear().domain([0, maxNumProjects]).range([5, 20]);

    var point = svg.selectAll(".point")
      .data(rectGrid(topBest));
      point.enter()
      .append('g')
      .attr('id', function(d) { return 'g_' + d.id; })
      .attr("transform", function(d) {
        return "translate(" + (margin + d.x + rectGrid.nodeSize()[0]/2) + "," + (margin + d.y + rectGrid.nodeSize()[1]/2) + ")";
      })

    point.append("path")
      .attr("class", "point")
      .attr("stroke", "none")
      .attr("stroke-width", 2)
      .attr("fill", "red")
      .attr("d", function(d) { return lineFunction(superPoints(0, 4)); })
      .transition().duration(1000)
      .delay(function(d, i) { return i * 100; })
      .attr("d", function(d) { return lineFunction(superPoints(sizeScale(d.numProjects), 4)); })

    point.append("text")
      .attr("class", "pointLabel")
      .attr('y', 100)
      .attr('text-anchor', 'middle')
      .text(function(d) { return d.orgLabel })
      .attr('fill', 'black')

    topBest.forEach(pullCollaborators);
  });
}

function pullCollaborators(academicOrg, academicOrgIndex) {
  var g = d3.select('#g_' + academicOrg.id);
  var r = 80;
  var minr = 20;
  var sizes = {
    large: 7,
    medium: 5,
    small: 3,
    micro: 2
  };
  ds.getOrganizationCollaborators(academicOrg.org).then(function(data) {
    randomPoints = seq(data.rows.length).map(function() {
      while(true) {
        x = Math.random() * 2 * r - r
        y = Math.random() * 2 * r - r
        len = Math.sqrt(x*x + y*y)
        if (len < r && len > minr) {
          return {x:x, y:y};
        }
      }
    })
    data.rows.forEach(function(collaboratorInfo, collaboratorIndex) {
      if (collaboratorInfo.collaborator == academicOrg.org) {
        return;
      }

      g.append('circle')
        .attr('cx', randomPoints[collaboratorIndex].x)
        .attr('cy', randomPoints[collaboratorIndex].y)
        .attr('r', sizes[collaboratorInfo.collaboratorSizeLabel])
        .style('fill', odiColors[1])
        .style('opacity', 0.5)
    });
  })
}

window.onload = init;

</script>
</head>
<body>
  <div id="charts"></div>
</body>
</html>