<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TSB Data Viz</title>
<style type="text/css">
text {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 12px;
}
.nameLabel {
  xdisplay: none;
  opacity: 0;
  transition: opacity 0.3s; -webkit-transition: opacity 0.3s;
}

g:hover .nameLabel {
  xdisplay: block;
  opacity: 1;
}
</style>
<script type="text/javascript" src="../lib/d3.v3.min.js"></script>
<script type="text/javascript" src="../js/fields.js"></script>
<script type="text/javascript">

var odiColors = ['#2254F4', '#00B7FF', '#08DEF9', '#1DD3A7', '#0DBC37', '#67EF67', '#F9BC26', '#FF6700', '#D60303', '#EF3AAB', '#E6007C', '#B13198', ];

var w = 1280;
var h = 720;
var svg;

function init() {
  svg = d3.select('#charts')
    .append('svg')
    .attr('width', w)
    .attr('height', h);


  svg.append('rect')
    .attr('width', w)
    .attr('height', h)
    .style('fill', '#FAFAFA')

  loadData();
}

function sortByDecreasingCount(a, b) {
  return -(a.count - b.count); //decreasing order
}

function countValues(values) {
  var uniqueValues = {};
  var countedValues = [];
  values.forEach(function(value) {
    if (!uniqueValues[value]) {
      var valueInfo = { name : value, count : 0 };
      uniqueValues[value] = valueInfo;
      countedValues.push(valueInfo);
    }
    uniqueValues[value].count++;
  });
  countedValues.sort(sortByDecreasingCount);
  return countedValues;
}

function makeBubbles(data) {
  var pack = d3.layout.pack()
    .size([w - 4, h - 4])
    .sort(null)
    .value(function(d) { return Math.max(5, d.count/15); });

  console.log(d3.shuffle(data))

  var root = {
    name : 'Root',
    children : d3.shuffle(data)
  }

  var node = svg.datum(root).selectAll('.node')
      .data(pack.nodes)
    .enter().append('g')
      .attr('class', 'industries')
      .attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });

  node.append('circle')
    .style('fill', odiColors[2])
    .attr('r', function(d) { return 0; });

  node.append('text')
    .attr('fill', '#000000')
    .attr('x', function(d) { d.x })
    .attr('y', function(d) { d.y })
    .attr('dy', '.5em')
    .attr('class', 'label')
    .style('text-anchor', 'middle')
    .style('opacity', 0)
    .text(function(d) { return d.count })

  node.append('text')
    .attr('fill', '#000000')
    .attr('x', function(d) { d.x })
    .attr('y', function(d) { d.y })
    .attr('dy', '-.5em')
    .style('text-anchor', 'middle')
    .attr('class', 'nameLabel')
    .text(function(d) { return d.name })

  svg.selectAll('.industries circle')
    .transition()
    .duration(500)
    .delay(function(d, i) { return i * 10; })
    .attr('r', function(d) { return d.count ? d.r * 0.8 : 0; });

  svg.selectAll('.industries text.label')
    .transition()
    .duration(500)
    .delay(function(d, i) { return i * 10; })
    .style('opacity', 1);
}

function loadData() {
  d3.csv('../data/TSB-data-public.csv', function(error, rows) {
    console.log('Loaded ', rows.length, 'rows');

    var fieldName = 'AreaName';
    var areaNames = rows.map(function(row) { return row[fieldName] || 'Unknown' });
    var countedAreaNames = countValues(areaNames);
    console.log(countedAreaNames);

    makeBubbles(countedAreaNames);
  });
}

window.onload = init;

</script>
</head>
<body>
  <div id="charts"></div>
</body>
</html>