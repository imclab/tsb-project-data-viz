<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TSB Data Viz</title>
<style type="text/css">
text {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 12px;
}
.nameLabel {
  xdisplay: none;
  opacity: 0;
  transition: opacity 0.3s; -webkit-transition: opacity 0.3s;
}

g:hover .nameLabel {
  xdisplay: block;
  opacity: 1;
}

.tooltip {
  display: none;
}
</style>
<script type="text/javascript" src="../lib/d3.v3.min.js"></script>
<script type="text/javascript" src="../js/fields.js"></script>
<script type="text/javascript">

var odiColors = ['#2254F4', '#00B7FF', '#08DEF9', '#1DD3A7', '#0DBC37', '#67EF67', '#F9BC26', '#FF6700', '#D60303', '#EF3AAB', '#E6007C', '#B13198', ];

var w = 1280;
var h = 720;
var svg;
var restartBtn;

function init() {
  svg = d3.select('#charts')
    .append('svg')
    .attr('width', w)
    .attr('height', h);


  svg.append('rect')
    .attr('width', w)
    .attr('height', h)
    .style('fill', '#FAFAFA')

  loadData();
}

function sortByDecreasingCount(a, b) {
  return -(a.count - b.count); //decreasing order
}

function countValues(values) {
  var uniqueValues = {};
  var countedValues = [];
  values.forEach(function(value) {
    if (!uniqueValues[value]) {
      var valueInfo = { name : value, count : 0 };
      uniqueValues[value] = valueInfo;
      countedValues.push(valueInfo);
    }
    uniqueValues[value].count++;
  });
  countedValues.sort(sortByDecreasingCount);
  return countedValues;
}

function makeBubbles(data, rows) {
  var pack = d3.layout.pack()
    .size([w - 4, h - 4])
    .sort(null)
    .value(function(d) { return Math.max(5, d.count/15); });

  var root = {
    name : 'Root',
    children : d3.shuffle(data)
  }

  var node = svg.datum(root).selectAll('.node')
      .data(pack.nodes)
    .enter().append('g')
      .attr('class', 'industries')
      .attr('transform', function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });

  node.append('circle')
    .style('fill', odiColors[2])
    .attr('r', function(d) { return 0; });

  node.append('text')
    .attr('fill', '#000000')
    .attr('x', function(d) { d.x })
    .attr('y', function(d) { d.y })
    .attr('dy', '.3em')
    .attr('class', 'label')
    .style('text-anchor', 'middle')
    .style('opacity', 0)
    .text(function(d) { return splitWords(d.name.replace(/[^A-Za-z ]/g,'')).map(getFirstLetter).slice(0,3).join('') })

  node.append('text')
    .attr('fill', '#000000')
    .attr('x', function(d) { d.x })
    .attr('y', function(d) { d.y })
    .attr('dy', function(d) { return -d.r })
    .attr('class', 'circleTitle')
    .style('text-anchor', 'middle')
    .style('fill', odiColors[2])
    .style('opacity', 0)
    .style('display', 'none')
    .text(function(d) { return d.name })

  node.on('mouseenter', function(d) {
    tooltip.style('display', 'block');
    tooltipText.text(d.name)
  });

  node.on('mouseleave', function(d) {
    tooltip.style('display', 'none');
  });

  svg.selectAll('.industries circle')
    .transition()
    .duration(500)
    .delay(function(d, i) { return i * 10; })
    .attr('r', function(d) { return d.count ? d.r * 0.8 : 0; });

  svg.selectAll('.industries text.label')
    .transition()
    .duration(500)
    .delay(function(d, i) { return i * 10; })
    .style('opacity', 1);

  node.on('click', function(clickedNode, clickedNodeIndex) {
    if (restartBtn.style('display') == 'block') {
      return;
    }
    tooltip.style('display', 'none');
    restartBtn.style('display', 'block')

    svg.selectAll('.industries circle').filter(function(d, i) { return i != clickedNodeIndex; })
      .transition()
      .duration(500)
      .delay(function(d, i) { return i * 10; })
      .attr('r', function(d, i) { return 0; });

    svg.selectAll('.industries text.label').filter(function(d, i) { return i != clickedNodeIndex; })
      .transition()
      .duration(500)
      .delay(function(d, i) { return i * 10; })
      .style('opacity', 0 )

    d3.select(this).selectAll('.circleTitle').style('display', 'block')
      .transition()
      .delay(500)
      .duration(500)
      .style('opacity', 1)

    svg.selectAll('.industries').filter(function(d, i) { return i == clickedNodeIndex; })
      .transition()
      .delay(500)
      .duration(1500)
      .attr('transform', function(d) { return 'translate(' + w/2 + ',' + 150 + ')'; })
      .each('end', function() {
        displayTopParticipants(rows, clickedNode.name)
      })

    svg.selectAll('.industries').filter(function(d, i) { return i != clickedNodeIndex; })
      .transition()
      .duration(500)
      .delay(function(d, i) { return i * 10; })
      .remove()

  })


  var tooltip = svg.append('g')
    .attr('class', 'tooltip')

  tooltip.append('rect')
    .attr('width', 200)
    .attr('height', '1.6em')
    .style('fill', odiColors[1])
    .attr('rx', '5px')
    .attr('ry', '5px')

  var tooltipText = tooltip.append('text')
    .text('BLA BLA')
    .attr('dx', '0.5em')
    .attr('dy', '1.5em')
    .style('fill', '#FFFFFF')
    .style('font-size', '12px')

  svg.on('mousemove', function(e) {
    tooltip.attr('transform', function(d) { return 'translate(' + d3.event.x + ',' + (d3.event.y-20) + ')'; });
  })
}

function displayTopParticipants(items, areaName) {
  var areaRows = items.filter(function(item) { return item['AreaName'] == areaName });
  var participants = countValues(extractField(areaRows, 'ParticipantName'));
  var projects = groupBy(areaRows, 'TSBProjectNumber');
  var projectsByParticipant = groupBy(areaRows, 'ParticipantName');
  var topParticipants = participants.slice(0, 30);

  console.log(topParticipants);

  function participantNameToIndex(name) {
    var idx = -1;
    topParticipants.forEach(function(p, i) {
      if (p.name == name) idx = i;
    })
    return idx;
  }

  function participantNameToOffset(name) {
    var offset = 0;
    topParticipants.forEach(function(p, i) {
      if (p.name == name) offset = p.offset;
    })
    return offset;
  }

  var totalCount = 0;
  var maxProjectCount = 0;
  topParticipants.forEach(function(participant, i) {
    projectsByParticipant.forEach(function(projectList, j) {
      if (i == 0 && j == 0) console.log(projectList);
      if (participant.name == projectList.key) {
        if (projectList.items.length > maxProjectCount) {
          maxProjectCount = projectList.items.length;
        }
        participant.projects = projectList.items;
        participant.offset = totalCount;
        totalCount += projectList.items.length;
      }
    })

    participant.otherCompaniesNames = {};
    participant.projects.forEach(function(project) {
      projects.forEach(function(projectInfo) {
        if (projectInfo.key == project.TSBProjectNumber) {
          projectInfo.items.forEach(function(item) {
            if (item.ParticipantName != participant.name) {
              participant.otherCompaniesNames[item.ParticipantName] = item.ParticipantName;
            }
          })
        }
      })
    })
    participant.otherCompanies = [];
    for(var otherCompanyName in participant.otherCompaniesNames) {
      participant.otherCompanies.push(otherCompanyName);
    }
    participant.otherCompaniesOffsets = participant.otherCompanies
      .map(participantNameToOffset)
      .filter(function(value) { return value; });
  })

  var line = d3.svg.line()
    .x(function(d,i) { return (100+(d/totalCount*(w-200))) })
    .y(function(d, i) { return (i==1) ? h/3 : h/2});

  topParticipants.forEach(function(participant, i) {
    participant.otherCompaniesOffsets.forEach(function(o) {
      svg
        .append("svg:path")
        .style('stroke', 'black')
        .style('fill', 'none')
        .attr("d", line([participant.offset, (participant.offset+o)/2, o]));
    })
  });

  var node = svg.selectAll('.participant')
    .data(topParticipants)
    .enter().append('g')
      .attr('class', 'participant')
      .attr('transform', function(d, i) {
        return 'translate(' + (100+(d.offset/totalCount*(w-200))) + ',' + h/2 + ')'; 
      });

  node.on('click', function(d,i) {
    console.log(d);
  })

  node.append('circle')
    .style('fill', function(d) {
      if (d.projects[0].CostCategoryType == 'Academic') return odiColors[4];
      else return odiColors[6];
    })
    .attr('r', function(d) { return 0; });

  node.append('text')
    .attr('fill', '#000000')
    .attr('class', 'label')
    .attr('dy', '0.3em')
    .style('text-anchor', 'middle')
    .style('opacity', 0 )
    .text(function(d) { return d.projects.length; })

  node.append('text')
    .attr('fill', '#000000')
    .attr('dx', function(d) { return 0})
    .attr('dy', function(d) { return 0})
    .attr('class', 'label')
    .text(function(d) { return d.name; })
    .style('opacity', 0 )
    .attr('transform', function(d) { return 'translate('+0+','+(d.projects.length/maxProjectCount * 50+20)+')rotate(50)' })

  svg.selectAll('.participant circle')
    .transition()
    .duration(500)
    .delay(function(d, i) { return i * 20; })
    .attr('r', function(d, i) { return d.projects.length/maxProjectCount * 40; });

  svg.selectAll('.participant text.label')
    .transition()
    .duration(500)
    .delay(function(d, i) { return i * 20; })
    .style('opacity', 1 )

}

function groupBy(items, propertyName) {
  var groups = {};
  items.forEach(function(item) {
    if (!groups[item[propertyName]]) groups[item[propertyName]] = []
    groups[item[propertyName]].push(item);
  })
  var result = [];
  var keys = [];
  for(var i in groups) {
    keys.push(i);
    result.push({
      key: i,
      items: groups[i]
    })
  }
  result.keys = keys;
  return result;
}

function extractField(items, propertyName) {
  return items.map(function(item) { return item[propertyName] || 'Unknown' });
}

function getFirstLetter(s) {
  return s[0];
}

function splitWords(s) {
  return s.split(' ');
}

function loadData() {
  d3.csv('../data/TSB-data-public.csv', function(error, rows) {
    console.log('Loaded ', rows.length, 'rows');

    var fieldName = 'AreaName';
    var areaNames = rows.map(function(row) { return row[fieldName] || 'Unknown' });
    var countedAreaNames = countValues(areaNames);

    makeBubbles(countedAreaNames, rows);

    restartBtn = svg.append('text')
      .attr('class', 'restartBtn')
      .text('< restart')
      .attr('x', 10)
      .attr('y', 20)
      .style('flll', '#000000')
      .style('display', 'none')
      .on('mouseover', function() {
        this.style.fill = 'red';
        this.style.cursor = 'pointer';
      })
      .on('mouseleave', function() {
        this.style.fill = 'black';
      })
      .on('click', function() {
        this.style.display = 'none';

        svg.selectAll('.industries')
          .transition()
          .duration(500)
          .remove()

        svg.selectAll('.industries circle')
          .transition()
          .duration(500)
          .attr('r', 0)
          .each('end', function() {
            makeBubbles(countedAreaNames, rows);
          })

        svg.selectAll('.industries text')
          .transition()
          .duration(500)
          .style('opacity', 0);

        svg.selectAll('.participant')
          .transition()
          .duration(600)
          .remove()

        svg.selectAll('.participant circle')
          .transition()
          .duration(500)
          .attr('r', 0)

        svg.selectAll('.participant text')
          .transition()
          .duration(500)
          .style('opacity', 0);
      })
    displayTopParticipants(rows, 'High Value Manufacturing')
  });
}

window.onload = init;

</script>
</head>
<body>
  <div id="charts"></div>
</body>
</html>