<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TSB Data Viz</title>
<style type="text/css">
text {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 12px;
}
.nameLabel {
  xdisplay: none;
  opacity: 0;
  transition: opacity 0.3s; -webkit-transition: opacity 0.3s;
}

g:hover .nameLabel {
  xdisplay: block;
  opacity: 1;
}

.tooltip {
  display: none;
}

.x.axis path {
  display: none;
}
</style>
<script type="text/javascript" src="../lib/d3.v3.min.js"></script>
<script type="text/javascript" src="../js/fields.js"></script>
<script type="text/javascript">

var odiColors = ['#2254F4', '#00B7FF', '#08DEF9', '#1DD3A7', '#0DBC37', '#67EF67', '#F9BC26', '#FF6700', '#D60303', '#EF3AAB', '#E6007C', '#B13198', ];

var w = window.innerWidth;
var h = window.innerHeight*0.7;
var svg;

function init() {
  loadData();
}

function groupBy(items, propertyName) {
  var groups = {};
  items.forEach(function(item) {
    if (!groups[item[propertyName]]) groups[item[propertyName]] = []
    groups[item[propertyName]].push(item);
  })
  var result = [];
  var keys = [];
  for(var i in groups) {
    keys.push(i);
    result.push({
      key: i,
      items: groups[i]
    })
  }
  result.keys = keys;
  return result;
}

function extractField(items, propertyName) {
  return items.map(function(item) { return item[propertyName] || 'Unknown' });
}

function uniqueValues(list) {
  var values = {};
  var result = [];
  list.forEach(function(value) {
    if (!values[value]) {
      values[value] = true;
      result.push(value);
    }
  });
  return result;
}

function compareByFieldName(fieldName) {
  return function(a, b) {
    return a[fieldName] - b[fieldName];
  }
}

function negate(f) {
  return function() {
    return -f.apply(this, arguments);
  }
}

function listOfFieldValues(obj) {
  var result = [];
  for(var i in obj) {
    result.push(obj[i]);
  }
  return result;
}

function loadData() {
  d3.csv('../data/TSB-data-public.csv', function(error, rows) {
    var projects = groupBy(rows, 'TSBProjectNumber');
    var clusterBy = 'AreaBudgetHolder';
    var years = [];
    var areas = {};
    for(var i=0; i<projects.length; i++) {
      var project = projects[i];
      var year = project.items[0].CompetitionYear;
      var area = project.items[0].AreaBudgetHolder;
      if (!years[year]) {
        years[year] = {};
      }
      if (!years[year][area]) {
        years[year][area] = 0;
      }
      if (!areas[area]) {
        areas[area] = {};
      }
      if (!areas[area][year]) {
        areas[area][year] = 0;
      }
      var totalGrant = project.items.reduce(function(prev, curr) {
        return prev + Number(curr.OfferGrant);
      }, 0)
      years[year][area] += totalGrant;
      areas[area][year] += totalGrant;
    }
    var maxEver = 0;
    for(var year in years) {
      for(var area in years[year]) {
        maxEver = Math.max(maxEver, years[year][area]);
      }
    }
    console.log(maxEver);

    for(var areaName in areas) {
      var area = areas[areaName];
      var values = [];
      for(var year in area) {
        values.push( { year : Number(year), value : area[year] })
      }
      areas[areaName] = values;
    }
    console.log(areas);

    makeChart(years, areas, maxEver);
  });
}

function makeChart(years, areas, maxEver) {
  var margin = {top: 20, right: 20, bottom: 30, left: 50}
  var width = w - margin.left - margin.right;
  var height = h - margin.top - margin.bottom;

  var x = d3.scale.linear().range([0, width]);
  var y = d3.scale.linear().range([height, 100]);

  var xAxis = d3.svg.axis()
      .scale(x)
      .orient('bottom');

  var yAxis = d3.svg.axis()
      .scale(y)
      .orient('left');

  var data = areas.Digital;

  var line = d3.svg.line()
      .x(function(d) { return x(d.year); })
      .y(function(d) { return y(d.value); });

  var svg = d3.select('#charts').append('svg')
      .attr('width', width + margin.left + margin.right)
      .attr('height', height + margin.top + margin.bottom)
    .append('g')
      .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

  x.domain([2003, 2013]);
  y.domain([0, maxEver]);

  var i = 0;
  for(var areaName in areas) {
    i++;
    var area = areas[areaName];
    svg.append("path")
      .datum(area)
      .attr("class", "line")
      .attr("d", line)
      .style('fill', 'none')
      .style('stroke', odiColors[i] || "#000000")
      .style('stroke-width', 2)
      .style('opacity', 0.5)
    svg.append("text")
      .text(areaName)
      .attr('dx', 0)
      .attr('dy', 0 + 20 * i)
      .style('fill', odiColors[i] || "#000000")
  }

  //var yearsFormatter = d3.format(",.0f");
  //console.log()

  svg.append("g")
      .attr("class", "x axis")
      //.tickFormat(function(d) { return "$" + yearsFormatter(d); })
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

}

window.onload = init;

</script>
</head>
<body>
  <div id="charts"></div>
</body>
</html>