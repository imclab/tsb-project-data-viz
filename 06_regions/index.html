<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TSB Data Viz</title>
<style type="text/css">
text {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 12px;
}

.label {
  fill: #999;
  text-transform: uppercase;
}

.bigNum {
  font-size: 200%;
}

.medNum {
  font-size: 160%;
}

.nameLabel {
  xdisplay: none;
  opacity: 0;
  transition: opacity 0.3s; -webkit-transition: opacity 0.3s;
}

g:hover .nameLabel {
  xdisplay: block;
  opacity: 1;
}

.tooltip {
  display: none;
}

.x.axis path {
  display: none;
}
</style>
<script type="text/javascript" src="../lib/d3.v3.min.js"></script>
<script type="text/javascript" src="../js/fields.js"></script>
<script type="text/javascript" src="DataSet.js"></script>
<script type="text/javascript">

var w = window.innerWidth;
var h = window.innerHeight*0.7;
var svg;
var mapSVG = '../data/United_Kingdom_Map_-_Region.svg';
var dataSet;
var mapScale = 0.25;

var odiColors = [
  '#2254F4', '#00B7FF', '#08DEF9', '#1DD3A7',
  '#0DBC37', '#67EF67', '#F9BC26', '#FF6700',
  '#D60303', '#EF3AAB', '#E6007C', '#B13198'
];

var regionNameMap = [
  ['North West England', 'North West'],
  ['North East England', 'North East'],
  ['South West England', 'South West'],
  ['South East England', 'South East']
];

var unusedShapes = ['Ireland', 'IsleOfMan', 'ChannelIslands', 'Border1', 'Border2', 'Border3'];

function init() {
  svg = d3.select('#charts').append('svg')
    .attr('width', w)
    .attr('height', h);

  loadMap();
}


function loadMap() {
  console.log('loadMap');
  d3.xml(mapSVG, 'image/svg+xml', function(xml) {
    var svgDoc = document.importNode(xml.documentElement, true);
    var svgMap = svgDoc.getElementById('map');
    svg[0][0].appendChild(svgMap);
    var bb = svgMap.getBoundingClientRect();
    var mapX = -bb.left * mapScale;
    var mapY = -bb.top * mapScale;
    var mapWidth = (bb.right - bb.left) * mapScale;
    var mapHeight = (bb.bottom - bb.top) * mapScale;
    mapX += w/2 - mapWidth/2;
    mapY += h/2 - mapHeight/2;
    svg.select('#map').attr('transform', 'translate(' + mapX + ',' + mapY + ') scale(' + mapScale + ',' + mapScale + ')');

    loadData();
  });
}


function regionNameToSvgId(name) {
  //make camel case and remove spaces
  var id = name.split(' ').map(function(s) { return s[0].toUpperCase() + s.substr(1);}).join('');
  return id;
}

function loadData() {
  d3.csv('../data/TSB-data-public-sample.csv', function(error, rows) {
    //normalize region names
    rows.forEach(function(row) {
      regionNameMap.forEach(function(regionMapping) {
        if (row.Region == regionMapping[0]) {
          row.Region = regionMapping[1];
        }
      });
    });

    dataSet = DataSet.fromArray(rows);

    var offsetFromTop = 400;

    var regionalData = dataSet.groupBy('Region');
    for(var regionName in regionalData) {
      regionalData[regionNameToSvgId(regionName)] = regionalData[regionName];
    }

    var regionIds = dataSet.uniqueValues('Region').map(regionNameToSvgId);
    regionIds.forEach(function(regionId, i) {

      var regionData = regionalData[regionId];
      var projects = regionData.groupBy('TSBProjectNumber');
      //console.log(regionId, projects.uniqueValues.length);

      svg.transition().select('#' + regionId)
        .style('fill', odiColors[i%odiColors.length])
        .selectAll('path')
        .style('fill', odiColors[i%odiColors.length]);

      var region = svg.select('#' + regionId);
      if (region.size() == 0) return;
      var regionBbox = region.node().getBoundingClientRect();

      var regionX = -regionBbox.left - (regionBbox.right - regionBbox.left)/2 + w*0.05 + w*0.05 + i * w*0.8/regionIds.length;
      var regionY = -regionBbox.top + offsetFromTop;
      if (i == 11) {
        regionX -= 70;
      }
      region.transition().delay(1000).duration(2000).attr('transform', 'translate('+regionX/mapScale+','+regionY/mapScale+')');

      var cx = w*0.05 + (i + 0.25) * w*0.8/regionIds.length;
      if (i == 11) {
        cx -= 40;
      }


      var totalGrant = 0;
      var totalGrantByArea = {};

      projects.uniqueValues.forEach(function(projectId, pi) {
        if (!projects[projectId]) return;
        var project = projects[projectId].rows[0];
        var grant = Number(project.OfferGrant);;
        totalGrant += grant;

        var areaHash = project.AreaBudgetHolder.trim().replace(/ /g, '');
        if (!totalGrantByArea[areaHash]) {
          totalGrantByArea[areaHash] = 0;
        }
        totalGrantByArea[areaHash] += grant;
      });

      var areas = [];
      for(var a in totalGrantByArea) {
        areas.push({name:a, value:totalGrantByArea[a]})
      }
      areas.sort(function(a, b) {
        return b.value - a.value;
      })

      for(var i=0; i<3; i++) {
        svg.append('text')
        .text(areas[i].name.substr(0, 7))
        .attr('class', 'label')
        .attr('dx', cx)
        .attr('dy', 100 + i*20)
        .style('opacity', 0)
        .transition()
        .delay(3000)
        .duration(1000)
        .style('opacity', 1 - i/3)
      }

      console.log(areas)

      function toMillion(m) {
        return Math.floor(m/1000000);
      }

      svg.append('text')
        .text(regionId.replace('AndTheHumber', ''))
        .attr('dx', cx)
        .attr('dy', offsetFromTop - 50)
        .style('opacity', 0)
        .transition()
        .delay(2000)
        .duration(1000)
        .style('opacity', 1)

      svg.append('text')
        .text(projects.uniqueValues.length)
        .attr('class', 'bigNum')
        .attr('dx', cx)
        .attr('dy', 300)
        .style('opacity', 0)
        .transition()
        .delay(3000)
        .duration(1000)
        .style('opacity', projects.uniqueValues.length/500)

      svg.append('text')
        .text('Projects')
        .attr('class', 'label')
        .attr('dx', cx)
        .attr('dy', 270)
        .style('opacity', 0)
        .transition()
        .delay(3000)
        .duration(1000)
        .style('opacity', 1)

      svg.append('text')
        .text('Grant')
        .attr('class', 'label')
        .attr('dx', cx)
        .attr('dy', 200)
        .style('opacity', 0)
        .transition()
        .delay(3000)
        .duration(1000)
        .style('opacity', 1)

      svg.append('text')
        .text(toMillion(totalGrant)+'M')
        .attr('class', 'medNum')
        .attr('dx', cx)
        .attr('dy', 230)
        .style('opacity', 0)
        .transition()
        .delay(3000)
        .duration(1000)
        .style('opacity', toMillion(totalGrant)/150)
    })

    unusedShapes.forEach(function(unusedShapeId) {
      svg.select('#' + unusedShapeId).style('display', 'none');
    });
  });
}

window.onload = init;

</script>
</head>
<body>
  <div id="charts"></div>
</body>
</html>