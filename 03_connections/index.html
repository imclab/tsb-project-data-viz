<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TSB Data Viz</title>
<style type="text/css">
text {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 12px;
}
.nameLabel {
  xdisplay: none;
  opacity: 0;
  transition: opacity 0.3s; -webkit-transition: opacity 0.3s;
}

g:hover .nameLabel {
  xdisplay: block;
  opacity: 1;
}

.tooltip {
  display: none;
}
</style>
<script type="text/javascript" src="../lib/d3.v3.min.js"></script>
<script type="text/javascript" src="../js/fields.js"></script>
<script type="text/javascript">

var odiColors = ['#2254F4', '#00B7FF', '#08DEF9', '#1DD3A7', '#0DBC37', '#67EF67', '#F9BC26', '#FF6700', '#D60303', '#EF3AAB', '#E6007C', '#B13198', ];

var w = window.innerWidth;
var h = window.innerHeight;
var svg;

function init() {
  svg = d3.select('#charts')
    .append('svg')
    .attr('width', w)
    .attr('height', h);

  svg.append('rect')
    .attr('width', w)
    .attr('height', h)
    .style('fill', '#FAFAFA')

  loadData();
}

function groupBy(items, propertyName) {
  var groups = {};
  items.forEach(function(item) {
    if (!groups[item[propertyName]]) groups[item[propertyName]] = []
    groups[item[propertyName]].push(item);
  })
  var result = [];
  var keys = [];
  for(var i in groups) {
    keys.push(i);
    result.push({
      key: i,
      items: groups[i]
    })
  }
  result.keys = keys;
  return result;
}

function extractField(items, propertyName) {
  return items.map(function(item) { return item[propertyName] || 'Unknown' });
}

function uniqueValues(list) {
  var values = {};
  var result = [];
  list.forEach(function(value) {
    if (!values[value]) {
      values[value] = true;
      result.push(value);
    }
  });
  return result;
}

function compareByFieldName(fieldName) {
  return function(a, b) {
    return a[fieldName] - b[fieldName];
  }
}

function negate(f) {
  return function() {
    return -f.apply(this, arguments);
  }
}

function listOfFieldValues(obj) {
  var result = [];
  for(var i in obj) {
    result.push(obj[i]);
  }
  return result;
}

function loadData() {
  d3.csv('../data/TSB-data-public-sample.csv', function(error, rows) {
    rows = rows.slice(0, 500);
    console.log('Loaded ', rows.length, 'rows');
    var participants = {};
    var participantNames = uniqueValues(extractField(rows, 'ParticipantName'));
    var isAcademic = {};
    groupBy(rows, 'ParticipantName').forEach(function(participant) {
      isAcademic[participant.key] = (participant.items[0].CostCategoryType == 'Academic');
    })
    participantNames.forEach(function(name) {
      if (!name) return;
      participants[name] = { name : name, academic: isAcademic[name], numConnections: 0, numProjects: 0, connections : {} };
    })
    var projects = groupBy(rows, 'TSBProjectNumber');
    projects.forEach(function(project) {
      var projectParticipants = uniqueValues(extractField(project.items, 'ParticipantName'));
      projectParticipants.forEach(function(participant, i) {
        participants[participant].numProjects++;
      });
      projectParticipants.forEach(function(participant, i) {
        projectParticipants.forEach(function(otherParticipant, j) {
          if (j <= i) return;
          if (!participants[participant].connections[otherParticipant]) {
            participants[participant].connections[otherParticipant] = 0;
            participants[participant].numConnections++;
          }
          if (!participants[otherParticipant].connections[participant]) {
            participants[otherParticipant].connections[participant] = 0;
            participants[otherParticipant].numConnections++;
          }
          participants[participant].connections[otherParticipant]++;
          participants[otherParticipant].connections[participant]++;
        })
      })
    })
    var participantsList = listOfFieldValues(participants);
    participantsList.sort(negate(compareByFieldName('numConnections')));

    participantsList.forEach(function(participant, i) {
      participant.index = i;
    });

    makeGraph(participants, participantsList);
  });
}

function makeGraph(participants, participantsList) {
  var force = d3.layout.force()
    .charge(-40)
    .linkDistance(5)
    .size([w, h]);


  var nodes = participantsList;
  var links = [];

  participantsList.forEach(function(participant) {
    for(var otherParticipantName in participant.connections) {
      var otherParticipant = participants[otherParticipantName];
      links.push({source:participant.index, target:otherParticipant.index, value:1})
    }
  })

  console.log('makeGraph', 'nodes:', nodes.length);

  force
      .nodes(nodes)
      .links(links)
      .start();

  var link = svg.selectAll('.link')
      .data(links)
      .enter().append('line')
      .attr('class', 'link')
      .style('stroke', 'rgba(128, 90, 18, 0.2)')
      .style('stroke-width', function(d) { return 1 });

  var node = svg.selectAll('.node')
      .data(nodes)
    .enter().append('circle')
      .attr('class', 'node')
      .attr('r', 3)
      .style('fill', function(d) { return d.academic ? odiColors[4] : odiColors[6] })
      .call(force.drag);

  node.append("title")
      .text(function(d) { return d.name; });

  force.on('tick', function() {
    link.attr('x1', function(d) { return d.source.x; })
        .attr('y1', function(d) { return d.source.y; })
        .attr('x2', function(d) { return d.target.x; })
        .attr('y2', function(d) { return d.target.y; });

    node.attr('cx', function(d) { return d.x; })
        .attr('cy', function(d) { return d.y; });
  });

}

window.onload = init;

</script>
</head>
<body>
  <div id="charts"></div>
</body>
</html>