<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TSB Data Viz</title>
<style type="text/css">
text {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 12px;
}
</style>
<script type="text/javascript" src="../lib/d3.v3.min.js"></script>
<script type="text/javascript" src="../js/fields.js"></script>
<script type="text/javascript" src="sparql.js"></script>
<script type="text/javascript" src="q.min.js"></script>
<script type="text/javascript" src="DataSet.js"></script>
<script type="text/javascript" src="SPARQLDataSource.js"></script>
<script type="text/javascript">
var w = window.innerWidth;
var h = window.innerHeight;
var svg;
var mapSVG = '../data/United_Kingdom_Map_-_Region.svg';
var dataSet;
var mapScale = window.innerHeight / 2000;

var odiColors = [
  '#2254F4', '#00B7FF', '#08DEF9', '#1DD3A7',
  '#0DBC37', '#67EF67', '#F9BC26', '#FF6700',
  '#D60303', '#EF3AAB', '#E6007C', '#B13198'
];

var regionsMap = {
  'E12000001' : 'North East',
  'E12000002' : 'North West',
  'E12000003' : 'Yorkshire and The Humber',
  'E12000004' : 'East Midlands',
  'E12000005' : 'West Midlands',
  'E12000006' : 'East of England',
  'E12000007' : 'London',
  'E12000008' : 'South East',
  'E12000009' : 'South West',
  'S92000003' : 'Scotland',
  'N92000002' : 'Northern Ireland',
  'W92000004' : 'Wales'
};

var ds = new SPARQLDataSource();
var exampleProject = 'http://tsb-projects.labs.theodi.org/id/project/100416';

function init() {
  svg = d3.select('#charts').append('svg')
    .attr('width', w)
    .attr('height', h);

  loadMap();
}

function regionNameToSvgId(name) {
  //make camel case and remove spaces
  var id = name.split(' ').map(function(s) { return s[0].toUpperCase() + s.substr(1);}).join('');
  return id;
}

function loadMap() {
  console.log('loadMap');
  d3.xml(mapSVG, 'image/svg+xml', function(xml) {
    var svgDoc = document.importNode(xml.documentElement, true);
    var svgMap = svgDoc.getElementById('map');
    svg[0][0].appendChild(svgMap);
    var bb = svgMap.getBoundingClientRect();
    var mapX = -bb.left * mapScale;
    var mapY = -bb.top * mapScale;
    var mapWidth = (bb.right - bb.left) * mapScale;
    var mapHeight = (bb.bottom - bb.top) * mapScale;
    mapX += w/2 - mapWidth/2;
    mapY += h/2 - mapHeight/2;
    var map = svg.select('#map');
    map.attr('transform', 'translate(' + mapX + ',' + mapY + ') scale(' + mapScale + ',' + mapScale + ')');

    for(var regionGovId in regionsMap) {
      var regionId = regionNameToSvgId(regionsMap[regionGovId]);
      svg.select('#' + regionId)
        .style('fill', '#DDD')
        .selectAll('path')
        .style('fill', '#DDD')
    }

    loadData();
  });
}

function addParticipantDot(participant) {
  var regionGovId = participant.participantRegion.substr(participant.participantRegion.lastIndexOf('/')+1);
  var regionId = regionNameToSvgId(regionsMap[regionGovId]);
  var region = svg.select('#' + regionId);
  var regionBbox = region.node().getBoundingClientRect();
  var cx = (regionBbox.right + regionBbox.left)/2 - 20 + Math.random() * 40;
  var cy = (regionBbox.top + regionBbox.bottom)/2 - 20 + Math.random() * 40;
  svg.append('circle')
    .attr('cx', cx)
    .attr('cy', cy)
    .attr('r', 3)
    .style('fill', 'red')

  //return { x : cx, y : cy };
  return [cx, cy];
}

function loadData() {
  var dots = [];
  ds.getProjectParticipants(exampleProject).then(function(data) {
    data.rows.forEach(function(participant) {
      dots.push(addParticipantDot(participant));
    })

    var d3_geom_voronoi = d3.geom.voronoi()//.x(function(d) { return d.x; }).y(function(d) { return d.y; });
    var link = svg.selectAll("line");
    link = link.data(d3_geom_voronoi.links(dots))
    console.log(d3_geom_voronoi.links(dots) );
    link.enter().append("line")
    link
      .style('stroke', 'red')
      .attr("x1", function(d) { return d.source[0]; })
      .attr("y1", function(d) { return d.source[1]; })
      .attr("x2", function(d) { return d.target[0]; })
      .attr("y2", function(d) { return d.target[1]; })
  });


}

window.onload = init;

</script>
</head>
<body>
  <div id="charts"></div>
</body>
</html>